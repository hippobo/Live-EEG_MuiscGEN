<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDI Sequence Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', sans-serif;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        #section1, #content, #controls {
            width: 90%; /* Responsive width */
            max-width: 800px; /* Maximum width */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px auto;
        }

        midi-player, midi-visualizer {
            width: 100%; /* Responsive width */
            max-width: 800px;
            height: 180px;
            margin: 10px 0;
        }

        #text {
            font-size: 1.2em;
            color: #000;
            margin: 10px 0;
            word-break: break-word; /* Prevents overflow on small screens */
        }

        input[type="number"], button, input[type="checkbox"] {
            font-size: 1.2em;
            margin: 5px;
            padding: 10px 20px;
        }

        h1, h2 {
            font-size: 2em;
            color: #333;
        }

        .token {
            font-size: 1em;
            margin: 0 5px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 10px;
        }

        .checkbox-label {
            margin-left: 5px;
        }

        @media (max-width: 600px) {
            h1, h2 {
                font-size: 1.5em;
            }

            #text {
                font-size: 1em;
            }
        }

        #quadrants {
    display: none; /* Initially hidden */
        }

    #controls {
        margin-top: 20px;
    }

    button {
        margin-top: 10px;
    }

    /* Use Bootstrap classes for buttons and input */
    button, input, label {
        margin: 5px 0;
    }


    

    </style>



<script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0"></script>

<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">



</head>

<body>

    <div>
        <input type="file" id="midiFileInput" accept=".mid,.midi" />
    </div>
    
    <section id="section1">
        <h1>MIDI Sequence Generator</h1>
        <midi-player src="https://cdn.jsdelivr.net/gh/cifkao/html-midi-player@2b12128/twinkle_twinkle.mid" sound-font visualizer="#section1 midi-visualizer"></midi-player>
        <midi-visualizer id="player" type="piano-roll" src="https://cdn.jsdelivr.net/gh/cifkao/html-midi-player@2b12128/twinkle_twinkle.mid"></midi-visualizer>
    </section>

    <div id="controls">
        <input type="number" id="maxValueInput" placeholder="Enter Sequence Length" step="10" />
    
        <button id="generateButton" class="btn btn-primary">Generate MIDI Sequence</button>
        <button id="clearContextButton" class="btn btn-secondary">Clear Context</button>

        <div class="checkbox-container">
            <input type="checkbox" id="noVA">
            <label for="noVA" class="checkbox-label">Use Valence Arousal Quadrant Values</label>
        </div>
        <a href="#"id="downloadButton" style="display: none;">
            <button >Download MIDI Sequence</button>
        </a>
    </div>


    <div id="quadrants">
       <canvas id="canvas" width="400" height="400" style="border:1px solid #000000;"></canvas>
    </div>

    <div id="content">
        <span id="text"></span>
        <span id="carret" class="text-black animate-ping">|</span>
    </div>



 





<script type="module">

import midiWriterJs from "https://cdn.skypack.dev/midi-writer-js@2.1.4";


let globalContext = [173];
let sequenceGenerated = false;
let useVA = false;


const generateButton = document.getElementById('generateButton');
const clearContextButton = document.getElementById('clearContextButton');
const useVAcheckbox = document.getElementById('noVA');

useVAcheckbox.addEventListener('change', function() {
    useVA = useVAcheckbox.checked;
    const quadrantsDiv = document.getElementById('quadrants');
    quadrantsDiv.style.display = useVA ? 'block' : 'none';
});

let quadrantCounts = [0,0,0,0];

 // Get the canvas and context
 const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Function to draw the initial quadrants
        function drawQuadrants() {
            const width = canvas.width;
            const height = canvas.height;

            // Draw horizontal line
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);

            // Draw vertical line
            ctx.moveTo(width / 2, 0);
            ctx.lineTo(width / 2, height);

            // Stroke the lines
            ctx.stroke();
        }

        // Function to update the tally for a quadrant
        function updateTally(x, y) {
            const width = canvas.width;
            const height = canvas.height;

            // Determine the quadrant
            let quadrant;
            if (x < width / 2 && y < height / 2) {
                quadrant = 1; // Top-left
            } else if (x >= width / 2 && y < height / 2) {
                quadrant = 0; // Top-right
            } else if (x < width / 2 && y >= height / 2) {
                quadrant = 2; // Bottom-left
            } else {
                quadrant = 3; // Bottom-right
            }

            // Increment the count for the quadrant and cycle back to 0 if it's currently 4
            quadrantCounts[quadrant] = (quadrantCounts[quadrant] + 1) % 5;

            // Redraw the quadrant tallies
            drawTallies();
        }

        
        function drawTallies() {
            const width = canvas.width;
            const height = canvas.height;

            // Clear the canvas first
            ctx.clearRect(0, 0, width, height);

            // Redraw the quadrants
            drawQuadrants();

            // Set font for tally text
            ctx.font = '20px Arial';
            ctx.fillStyle = 'black';

            // Draw the tally for each quadrant
            ctx.fillText(quadrantCounts[1], width * 0.25, height * 0.25); // Top-left
            ctx.fillText(quadrantCounts[0], width * 0.75, height * 0.25); // Top-right
            ctx.fillText(quadrantCounts[2], width * 0.25, height * 0.75); // Bottom-left
            ctx.fillText(quadrantCounts[3], width * 0.75, height * 0.75); // Bottom-right
        }

        // Event listener for canvas click
                canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            updateTally(x, y);
        });

        // Initial draw
        drawQuadrants();



const downloadButton = document.getElementById('downloadButton');
let midiBlob; 



const text = document.getElementById("text")
      const display = (token) => {
        globalContext.push(token);
        text.innerHTML = globalContext.join(' ')
    
       
        
      }
      const clearContext = () => {
        globalContext = [173];  // Reset the context
        text.innerHTML = '';  // Clear the display
        downloadButton.style.display = 'none'; // Hide the download button
        const midiPlayer = document.querySelector('midi-player');
        const midiVisualizer = document.querySelector('midi-visualizer');
        midiPlayer.src = '';
        midiVisualizer.src = '';
    }


    function updateButtonText() {
    generateButton.textContent = sequenceGenerated ? 'Add to Sequence' : 'Generate MIDI Sequence';
}


function updateMidiSource() {
    var input = document.getElementById('midiFileInput');
    var file = input.files[0];
    if (file) {
        var reader = new FileReader();

        reader.onload = function(e) {
            var midiPlayer = document.querySelector('midi-player');
            var midiVisualizer = document.querySelector('midi-visualizer');

            midiPlayer.src = e.target.result;
            midiVisualizer.src = e.target.result;

            midiPlayer.stop();
            midiPlayer.start();
        };

        reader.readAsDataURL(file);
    }
}


const displayTokenByToken = (tokens) => {
    tokenDisplay.innerHTML = ''; // Clear current display
    let index = 0;

    const intervalId = setInterval(() => {
        if(index < tokens.length){
            let span = document.createElement('span');
            span.classList.add('token');
            span.textContent = tokens[index] + ' ';
            tokenDisplay.appendChild(span);
            index++;
        } else {
            clearInterval(intervalId);
        }
    }, 1); // Adjust the interval time as needed
}

clearContextButton.addEventListener('click', () => {
    clearContext();
    sequenceGenerated = false; // Reset the flag
    updateButtonText(); // Update the button text
});


document.getElementById('midiFileInput').addEventListener('change', updateMidiSource);
const tokenDisplay = document.getElementById("text");

document.getElementById('generateButton').addEventListener('click', async () => {
        const maxValue = parseInt(document.getElementById('maxValueInput').value);

        if (isNaN(maxValue) || maxValue <= 0) {
            alert('Please enter a valid sequence length.');
            return;
        }

        const requestPayload = {
            sequence_length: maxValue,
            context: globalContext,
            quadrant_use : useVA,
            quadrant_counts : quadrantCounts
        };

        try {
            const response = await fetch('/generate_midi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestPayload)
            });

            if (response.ok) {
                const responseData = await response.json();

                // Update global context with the new sequence
                const newSequence = responseData.context;
                globalContext.push(...newSequence);

                // Update the download button with the link to the MIDI file
                downloadButton.style.display = 'block';
                
                downloadButton.href = responseData.midi_file_url;
                downloadButton.download = 'generated_midi_seq.mid';
                const midiPlayer = document.querySelector('midi-player');
                const midiVisualizer = document.querySelector('midi-visualizer');
                midiPlayer.src = responseData.midi_file_url;
                midiVisualizer.src = responseData.midi_file_url;

                midiPlayer.stop();
                midiPlayer.start();
                // Update generate button text
                sequenceGenerated = true;
                updateButtonText();
            } else {
                throw new Error('Failed to generate MIDI file');
            }
        } catch (error) {
            console.error(error.message);
        }
    });

updateButtonText();

</script>




</body>


</html>